---
title: Using destination selectors with multiple Terraform workspaces
description: |
    How to publish resources to different Terraform workspaces using destination
    selectors
sidebar_label: Using multiple Terraform destinations
keywords: [terraform, promise, destination, selectors]
---

One common question when using Kratix with Terraform is how to handle the
situation where requests need to be executed in different Terraform workspaces.

For instance, Team A has a Terraform workspace which should utilised when
infrastructure is created for that team via Terraform, whilst Team B has a
workspace that should accommodate their requests.

This guide will show you how to resolve this with dynamic scheduling within the
Promise by using inputs provided in the request to create Destination selectors
that Kratix will use to execute the request in the right places.

You will:
- Run an existing Promise that publishes resources to Terraform destinations
- Extend this Promise to direct resources to destinations based on team
  ownership


## Pre-requisites

To complete this guide you will need:

1. An AWS account for Terraform Cloud to use for infrastructure provisioning
1. A Terraform workspace configured to [watch a Git
   repository](https://developer.hashicorp.com/terraform/cloud-docs/workspaces/create). 
    As we'll also be creating an AWS resource, this workspace should have AWS credentials configured.
1. Two Terraform Destinations that are backed GitStateStores that references the 
   above repository. You can follow the [Configuring the Destination](/ske/integrations/tfe#configuring-the-destination)
   documentation to set up your Destination.
1. An installation of SKE. Go to [Configuring SKE](/ske/installing-ske/intro) and follow the appropriate guide if you haven't done so
   already.
1. The [kratix-cli](/main/kratix-cli/intro)
1. A [Promise that writes to Terraform](/ske/guides/promise-from-tf-module)

## Run the Terraform Promise

We will start by cloning and running an existing Promise that uses Terraform:

```shell
git clone git@github.com:syntasso/kratix-examples.git
cd kratix-examples
```

:::tip

We are using a pre-built Promise to focus on dynamic scheduling, but if you are
curious about how this Promise works, you can [build it
yourself](/ske/guides/promise-from-tf-module)!

:::

TODO: show the Promise request

TODO: run the Promise against Kratix

TODO: show the results

## Add dynamic scheduling to your Promise

We will now enhance the existing Promise to have another container that will
process Resource Requests and target different workspaces based on team
ownership.

Should a request have the below inputs:

```yaml
apiVersion: marketplace.kratix.io/v1alpha1
kind: redis
metadata:
  name: example
  namespace: default
  labels:
    non-kratix-label: "true"
spec:
  size: small
  team: team-a
```

The team ownership information comes from the `spec.team` field in the request.
Let's assume that we have two teams: `team-a` and `team-b`, each with a
corresponding workspace on Terraform Cloud.

Let's add a container that will process this information and use Kratix
**Destination Selectors** to point the resource to the correct Terraform
destination.

TODO: use the kratix-cli to add a new container

TODO: show the container in the pipeline YAML

TODO: add the below script to the container

```shell
export TEAM="$(yq eval '.spec.team' /kratix/input/object.yaml)"

echo """
--
- directory: ${TEAM}
  matchLabels:
     team: ${TEAM}     
""" >> /kratix/metadata/destination-selectors.yaml
```

This will ensure that resources are scheduled to a Destination with the label
`team: team-a` and this is backed by a state store that is watched by a
Terraform Workspace.

## ðŸŽ‰ Congratulations

Now you know how you can leverage Destination selectors in Kratix to
dynamically route resources to their intended Terraform workspaces!
