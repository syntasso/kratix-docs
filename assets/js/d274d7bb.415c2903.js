"use strict";(self.webpackChunkkratix_docs=self.webpackChunkkratix_docs||[]).push([[811],{28453:(e,t,n)=>{n.d(t,{R:()=>o,x:()=>a});var r=n(96540);const i={},s=r.createContext(i);function o(e){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),r.createElement(s.Provider,{value:t},e.children)}},78406:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>f,contentTitle:()=>p,default:()=>x,frontMatter:()=>u,metadata:()=>r,toc:()=>g});const r=JSON.parse('{"id":"ske/guides/scheduling-terraform-workspaces","title":"Scheduling to different Terraform Workspaces","description":"How to publish resources to different Terraform workspaces using destination\\nselectors\\n","source":"@site/docs/ske/05-guides/15-scheduling-terraform-workspaces.mdx","sourceDirName":"ske/05-guides","slug":"/ske/guides/scheduling-terraform-workspaces","permalink":"/ske/guides/scheduling-terraform-workspaces","draft":false,"unlisted":false,"editUrl":"https://github.com/syntasso/kratix-docs/tree/main/docs/ske/05-guides/15-scheduling-terraform-workspaces.mdx","tags":[],"version":"current","sidebarPosition":15,"frontMatter":{"title":"Scheduling to different Terraform Workspaces","description":"How to publish resources to different Terraform workspaces using destination\\nselectors\\n","keywords":["terraform","promise","destination","selectors"]},"sidebar":"skeSidebar","previous":{"title":"Creating a Promise from a Terraform Module","permalink":"/ske/guides/promise-from-tf-module"},"next":{"title":"Introduction","permalink":"/ske/integrations/intro"}}');var i=n(74848),s=n(28453);const o=n.p+"assets/images/tf-topology-87c7fe95a33f326deca40e5a6d41ff8f.jpg",a=n.p+"assets/images/tf-destinations-52e0f427c23c50ff04685b1fc9bd9601.jpg",l=n.p+"assets/images/tf-workspace-page-01-c6417220b07f1052a3f93c2dc8e2642d.jpg",c=n.p+"assets/images/tf-workspace-page-02-e49824eeb71a9453b234a42ab5a1beaf.jpg",h=n.p+"assets/images/tf-workspace-page-03-aa7517eb59b33d3e50ce379993e4fcdc.jpg",d=n.p+"assets/images/tf-workspace-page-04-6dd800a37f194aa647d21ad6f594d570.jpg",m=n.p+"assets/images/tf-destinations-tfe-49fef84265afee4bae49b965a37045a1.jpg",u={title:"Scheduling to different Terraform Workspaces",description:"How to publish resources to different Terraform workspaces using destination\nselectors\n",keywords:["terraform","promise","destination","selectors"]},p=void 0,f={},g=[{value:"Pre-requisites",id:"pre-requisites",level:2},{value:"An Overview of the Platform",id:"an-overview-of-the-platform",level:2},{value:"Configuring your Destinations",id:"configuring-your-destinations",level:2},{value:"Configuring Terraform Enterprise",id:"configuring-terraform-enterprise",level:2},{value:"Scheduling to destination dynamically",id:"scheduling-to-destination-dynamically",level:2},{value:"\ud83c\udf89 Congratulations",id:"-congratulations",level:2}];function w(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",li:"li",mdxAdmonitionTitle:"mdxAdmonitionTitle",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,s.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(t.p,{children:["SKE comes with a series of integrations, including one with ",(0,i.jsx)(t.a,{href:"/ske/integrations/tfe",children:"Terraform\nEnterprise"}),". With the integration, your Promises can\nschedule workloads to be run on HCP Terraform or Terraform Enterprise."]}),"\n",(0,i.jsx)(t.p,{children:"A common question when using SKE with Terraform is how to create Promises that\nschedule requests to be executed on different Terraform workspaces."}),"\n",(0,i.jsxs)(t.p,{children:["For example, suppose there are multiple teams in your organisation: a frontend\nteam, a mobile team, and a backend team. You want to isolate the workspaces in\nyour Terraform Enterprise, in such a way that members of a team only have access\nthe workspace for their team. For example, the mobile team has access to a\n",(0,i.jsx)(t.code,{children:"mobile-team-workspace"}),"."]}),"\n",(0,i.jsx)(t.p,{children:"This guide will show you how you can use Dynamic Scheduling within your Pipeline\nstages to achieve this outcome. You will:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"Learn how to use Destination Labels to control where requests go"}),"\n",(0,i.jsx)(t.li,{children:"Learn how to configure your Terraform workspaces to match your Destinations split"}),"\n",(0,i.jsx)(t.li,{children:"Learn how to use Destination Selectors for dynamic scheduling"}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"pre-requisites",children:"Pre-requisites"}),"\n",(0,i.jsx)(t.p,{children:"This guide will walk you through how to configure the Platform and the\nDestinations to work with an example Promise. You can just read through it."}),"\n",(0,i.jsx)(t.p,{children:"To install and execute the example Promise in your environment, you will need:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"An AWS account for Terraform Cloud to use for infrastructure provisioning"}),"\n",(0,i.jsxs)(t.li,{children:["A Terraform workspace configured to ",(0,i.jsx)(t.a,{href:"https://developer.hashicorp.com/terraform/cloud-docs/workspaces/create",children:"watch a Git\nrepository"}),".\nAs we'll also be creating an AWS resource, this workspace should have AWS\ncredentials configured."]}),"\n",(0,i.jsxs)(t.li,{children:["An installation of SKE. Go to ",(0,i.jsx)(t.a,{href:"/ske/installing-ske/intro",children:"Configuring SKE"}),"\nand follow the appropriate guide if you haven't done so already."]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"an-overview-of-the-platform",children:"An Overview of the Platform"}),"\n",(0,i.jsx)(t.p,{children:"Before we dive into configuring your Platform and installing and using the\nPromise, let's take a high-level view of what your Platform will look like, what\nwill the Promise output, and how SKE will process the request:"}),"\n","\n",(0,i.jsxs)("figure",{className:"diagram",children:[(0,i.jsx)("img",{className:"large",src:o,alt:"High-level diagram of the Platform"}),(0,i.jsx)("figcaption",{children:"How SKE will process the request"})]}),"\n",(0,i.jsx)(t.p,{children:"On the bottom, you can see the Destinations currently configured in the\nPlatform. In this example, we have three Destinations:"}),"\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsxs)(t.li,{children:["A ",(0,i.jsx)(t.code,{children:"frontend"})," Destination for the frontend team"]}),"\n",(0,i.jsxs)(t.li,{children:["A ",(0,i.jsx)(t.code,{children:"backend"})," Destination for the backend team"]}),"\n",(0,i.jsxs)(t.li,{children:["A ",(0,i.jsx)(t.code,{children:"platform"})," Destination for the platform team"]}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"On the right, you can see Terraform Enterprise. In it, we configured a Workspace\nfor each team. Each workspace is configured to watch a directory in a Git\nRepository. SKE will write the Terraform files to the right subdirectorty in the\nState Store depending on the Destination, and Terraform Enterprise will apply\nthe changes to the workspace."}),"\n",(0,i.jsx)(t.p,{children:"The example Promise in this guide provides S3 buckets as a service. Let's go\nthrough what happens when a member of the Mobile team requests a new S3 bucket:"}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsx)(t.li,{children:"The request for a new bucket is sent to the Platform. It includes the team\nmembership information."}),"\n",(0,i.jsx)(t.li,{children:"It hits the Platform via the Promise API, which will trigger the Promise\nworkflow."}),"\n",(0,i.jsx)(t.li,{children:"The Promise workflow is executed and outputs a series of Terraform files that\nwill be used by Terraform Enterprise to create the bucket. It also include a\nspecial Kratix metadata file, the destination selectors, that will be used by\nSKE to send the request to the correct Destination."}),"\n",(0,i.jsxs)(t.li,{children:["In this example, the Destination Selectors file will instruct SKE to send the\nrequest to the Destination with the label ",(0,i.jsx)(t.code,{children:"workspace: mobile"}),". The terraform\nfiles will be written to the the subdirectory in the State Store for the mobile\nteam."]}),"\n",(0,i.jsx)(t.li,{children:"Terraform Enterprise is configured to watch the State Store for the mobile\nteam. It will apply the changes to the workspace and create the bucket."}),"\n"]}),"\n",(0,i.jsx)(t.p,{children:"With that in mind, let's go through the details of how you can configure your\nPlatform to achieve this result."}),"\n",(0,i.jsx)(t.h2,{id:"configuring-your-destinations",children:"Configuring your Destinations"}),"\n",(0,i.jsxs)(t.admonition,{type:"tip",children:[(0,i.jsx)(t.mdxAdmonitionTitle,{}),(0,i.jsxs)(t.p,{children:["If you are not familiar with the concept of Destinations, you can read more\nabout them in the ",(0,i.jsx)(t.a,{href:"/main/reference/destinations/intro",children:"Destinations Reference\ndocs"})," or by trying out the ",(0,i.jsx)(t.a,{href:"/workshop/intro",children:"Kratix\nWorkshop"}),"."]})]}),"\n",(0,i.jsx)(t.p,{children:"The first step is to configure your Destinations to match the different\nWorkspaces you want to have in your Terraform Enterprise. Each Destination must\nhave an unique label, so SKE can identify the correct Destination to send the\nrequest to when a request comes in."}),"\n",(0,i.jsx)(t.p,{children:"The Destination mapping to the Mobile team workspace in TFE could look like this:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:"apiVersion: platform.kratix.io/v1alpha1\nkind: Destination\nmetadata:\n  name: mobile\n  labels:\n    workspace: mobile\nspec:\n  path: mobile-workspace\n  filepath:\n    mode: none\n  stateStoreRef:\n    name: gitops-state-store\n    kind: GitStateStore\n"})}),"\n",(0,i.jsx)(t.p,{children:"With all Destinations configured, you should see the following when listing the Destinations:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-shell-session",children:"$ kubectl get destinations --show-labels\nNAME       READY   LABELS\nmobile     True    workspace=mobile\nbackend    True    workspace=backend\nfrontend   True    workspace=frontend\n"})}),"\n",(0,i.jsx)(t.admonition,{title:"What about the State Store?",type:"info",children:(0,i.jsxs)(t.p,{children:["The State Store referenced by the Destination above is a Git repository that\nwill be written to by SKE and read from by Terraform Enterprise. Configuring it\nis outside the scope of this guide, but you can read more about it in the ",(0,i.jsx)(t.a,{href:"/main/reference/statestore/intro",children:"State\nStore Reference docs"}),"."]})}),"\n",(0,i.jsx)(t.p,{children:"At this point, your Platform should look like the diagram below:"}),"\n","\n",(0,i.jsxs)("figure",{className:"diagram",children:[(0,i.jsx)("img",{className:"",src:a,alt:"Destinations configured in the Platform"}),(0,i.jsx)("figcaption",{children:"Destinations configured in the Platform"})]}),"\n",(0,i.jsx)(t.h2,{id:"configuring-terraform-enterprise",children:"Configuring Terraform Enterprise"}),"\n",(0,i.jsx)(t.p,{children:"Next, let's configure Terraform Enterprise to watch for changes in the State\nStore. In this example, we will be using Terraform Cloud, but the same\nprinciples apply to Terraform Enterprise."}),"\n",(0,i.jsx)(t.p,{children:'First, go to the Terraform Cloud dashboard, select your Project and click on the\n"Workspaces" tab. Then click on the "New" to create a new Workspace.'}),"\n",(0,i.jsx)(t.admonition,{type:"tip",children:(0,i.jsxs)(t.p,{children:["For complete instructions on how to configure Terraform Cloud, please refer to\nthe ",(0,i.jsx)(t.a,{href:"https://developer.hashicorp.com/terraform/cloud-docs/workspaces/create",children:"Terraform Cloud\ndocumentation"}),"."]})}),"\n","\n",(0,i.jsxs)("figure",{className:"diagram",children:[(0,i.jsx)("img",{className:"large",src:l,alt:"Creating a new workspace in Terraform Cloud"}),(0,i.jsx)("figcaption",{children:"Creating a new workspace in Terraform Cloud"})]}),"\n",(0,i.jsx)(t.p,{children:'Since we want to watch the Git Repository, select the "Version Control Workflow"\nand follow the steps, selecting the right Organization and Repository. Note that\nthis repository must be the same one that is referenced by the State Store in\nthe Destination.'}),"\n",(0,i.jsxs)("figure",{className:"diagram",children:[(0,i.jsx)("img",{className:"large",src:c,alt:"Selecting the Repository"}),(0,i.jsx)("figcaption",{children:"Selecting the Repository"})]}),"\n",(0,i.jsxs)(t.p,{children:['Make sure that, when configuring the settings, you click in "Advanced Options"\nand select the subdirectory matching the Destination ',(0,i.jsx)(t.code,{children:"spec.path"}),". For example,\nfor the Mobile team workspace, we defined the ",(0,i.jsx)(t.code,{children:"spec.path"})," as ",(0,i.jsx)(t.code,{children:"mobile-workspace"}),",\nso we will select the ",(0,i.jsx)(t.code,{children:"mobile-workspace"})," subdirectory. Also make sure to check\nthe Auto Apply boxes to have Terraform Enterprise apply the changes to the\nworkspace automatically."]}),"\n",(0,i.jsxs)("figure",{className:"diagram",children:[(0,i.jsx)("img",{className:"large",src:h,alt:"Selecting the Subdirectory"}),(0,i.jsx)("figcaption",{children:"Selecting the Subdirectory"})]}),"\n",(0,i.jsx)(t.p,{children:"Once you finish configuring, you can click on Create and save your workspace. The Workspace Overview should look like this:"}),"\n",(0,i.jsxs)("figure",{className:"diagram",children:[(0,i.jsx)("img",{className:"large",src:d,alt:"Workspace Overview"}),(0,i.jsx)("figcaption",{children:"Workspace Overview"})]}),"\n",(0,i.jsx)(t.p,{children:"Repeat the same process for the Backend and Frontend workspaces. At this stage, your Platform should look like the diagram below:"}),"\n","\n",(0,i.jsxs)("figure",{className:"diagram",children:[(0,i.jsx)("img",{className:"large",src:m,alt:"Destinations configured in Terraform Cloud"}),(0,i.jsx)("figcaption",{children:"Destinations and TFE configured"})]}),"\n",(0,i.jsx)(t.h2,{id:"scheduling-to-destination-dynamically",children:"Scheduling to destination dynamically"}),"\n",(0,i.jsx)(t.p,{children:"With the Platform and Terraform Enterprise configured, we can now start scheduling requests to the correct Terraform workspace."}),"\n",(0,i.jsx)(t.admonition,{type:"tip",children:(0,i.jsxs)(t.p,{children:["We are using a pre-built Promise to focus on dynamic scheduling, but if you are\ncurious about how this Promise works, you can ",(0,i.jsx)(t.a,{href:"/ske/guides/promise-from-tf-module",children:"build it\nyourself"}),"!"]})}),"\n",(0,i.jsxs)(t.p,{children:["For that, we will use the S3 Bucket example Promise available ",(0,i.jsx)(t.a,{href:"https://github.com/syntasso/kratix-examples/tree/main/promise-terraform-aws-buckets",children:"here"}),". You can install the Promise with the following command:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-shell-session",children:"kubectl apply -f https://raw.githubusercontent.com/syntasso/kratix-examples/refs/heads/main/promise-terraform-aws-buckets/promise.yaml\n"})}),"\n",(0,i.jsx)(t.p,{children:"You should see the following output:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-shell-session",children:"NAME   STATUS      KIND   API VERSION                    VERSION\ns3     Available   S3     example.syntasso.io/v1alpha1   v0.0.1\n"})}),"\n",(0,i.jsxs)(t.p,{children:["As part of the Promise API, you will find a property called ",(0,i.jsx)(t.code,{children:"spec.team"}),". The value of this property will be used to determine the Terraform workspace to use for the request."]}),"\n",(0,i.jsx)(t.p,{children:"Inspect the Promise API:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-shell-session",children:"$ kubectl explain s3.spec.team --api-version=example.syntasso.io/v1alpha1\nGROUP:      example.syntasso.io\nKIND:       S3\nVERSION:    v1alpha1\n\nFIELD: team <string>\nENUM:\n    mobile\n    backend\n    frontend\n\nDESCRIPTION:\n    Team name identifier.\n"})}),"\n",(0,i.jsx)(t.p,{children:"But how is this property used? Let's inspect the Request Configure workflow:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-python",children:'#!/usr/bin/env python3\nimport kratix_sdk as ks\nimport sys\nfrom typing import List\n\ndef resource_configure() -> int:\n    sdk = ks.KratixSDK()\n    resource = sdk.read_resource_input()\n\n    team = resource.get_value("spec.team")\n    if not team or not isinstance(team, str):\n        print("Error: spec.team is required and must be a non-empty string", file=sys.stderr)\n        return 1\n\n    selectors: List[ks.DestinationSelector] = [\n        ks.DestinationSelector(match_labels={\n            "workspace": team\n        })\n    ]\n\n    sdk.write_destination_selectors(selectors)\n    print(f"Destination configured for team: {team}")\n    return 0\n\ndef main():\n    exit_code = resource_configure()\n    sys.exit(exit_code)\n\nif __name__ == \'__main__\':\n    main()\n'})}),"\n",(0,i.jsxs)(t.p,{children:["Note how the Promise is using the ",(0,i.jsx)(t.code,{children:"spec.team"})," property to determine which\n",(0,i.jsx)(t.em,{children:"Destination"})," the output of the Pipeline should be scheduled to, by writting a\n",(0,i.jsx)(t.code,{children:"destination-selectors.yaml"})," file in the ",(0,i.jsx)(t.code,{children:"/kratix/metadata"})," directory. The\nPromise above is using the Python SDK to produce a file that looks like this:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",metastring:'title="destination-selectors.yaml"',children:"- matchLabels:\n    workspace: ${team}\n"})}),"\n",(0,i.jsxs)(t.p,{children:["So when the team is ",(0,i.jsx)(t.code,{children:"mobile"}),", the ",(0,i.jsx)(t.code,{children:"destination-selectors.yaml"})," file will look like this:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",metastring:'title="destination-selectors.yaml"',children:"- matchLabels:\n    workspace: mobile\n"})}),"\n",(0,i.jsxs)(t.p,{children:["When SKE is processing the request, it will look for destinations matching the\n",(0,i.jsx)(t.code,{children:"matchLabels"})," defined in the file, ensuring that the resources are scheduled to\nthe correct Terraform workspace."]}),"\n",(0,i.jsx)(t.p,{children:"Which brings us back to the diagram at the beginning of this guide, where you can see how SKE will schedule the request to the correct Terraform workspace:"}),"\n",(0,i.jsxs)("figure",{className:"diagram",children:[(0,i.jsx)("img",{className:"large",src:o,alt:"High-level diagram of the Platform"}),(0,i.jsx)("figcaption",{children:"How SKE will process the request"})]}),"\n",(0,i.jsx)(t.admonition,{type:"tip",children:(0,i.jsxs)(t.p,{children:["You can read more about Dynamic Scheduling in the ",(0,i.jsx)(t.a,{href:"/main/reference/destinations/multidestination-management",children:"Managing Multiple\nDestinations"}),"\nreference documentation."]})}),"\n",(0,i.jsx)(t.h2,{id:"-congratulations",children:"\ud83c\udf89 Congratulations"}),"\n",(0,i.jsx)(t.p,{children:"Now you know how you can leverage Destination selectors in Kratix to\ndynamically route resources to their intended Terraform workspaces!"})]})}function x(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(w,{...e})}):w(e)}}}]);